generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum CustomerPlan {
  FREE
  INDIE
  STARTUP
}

enum JobType {
  EMAIL
  WEBHOOK
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum DeliveryStatus {
  SUCCESS
  FAILED
}

// ============================================
// CUSTOMER MODEL 
// ============================================

model Customer {
  id            String       @id @default(uuid()) @db.Uuid
  email         String       @unique
  apiKey        String       @unique @map("api_key")
  apiKeyHash    String       @unique @map("api_key_hash")
  plan          CustomerPlan @default(FREE)              
  monthlyLimit  Int          @default(1000) @map("monthly_limit")
  usageCount    Int          @default(0) @map("usage_count")
  usageResetAt  DateTime     @default(now()) @map("usage_reset_at")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  sendingDomain     String?   @map("sending_domain")         
  domainVerified    Boolean   @default(false) @map("domain_verified")
  sendgridDomainId  String?   @unique @map("sendgrid_domain_id")
  domainDnsRecords  Json?     @map("domain_dns_records")    
  domainRequestedAt DateTime? @map("domain_requested_at")
  domainVerifiedAt  DateTime? @map("domain_verified_at")

  jobs          Job[]

  @@index([apiKeyHash])
  @@index([email])
  @@map("customers")
}

// ============================================
// JOB MODEL
// ============================================

model Job {
  id              String    @id @default(uuid()) @db.Uuid
  customerId      String    @map("customer_id") @db.Uuid
  type            JobType   
  status          JobStatus @default(PENDING)   
  priority        Int       @default(5)
  payload         Json
  attempts        Int       @default(0)
  maxAttempts     Int       @default(3) @map("max_attempts")
  errorMessage    String?   @map("error_message")
  idempotencyKey  String?   @map("idempotency_key")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")

  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  deliveryLogs    DeliveryLog[]

  @@index([customerId])
  @@index([status])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@index([customerId, idempotencyKey])
  @@map("jobs")
}

// ============================================
// DELIVERY LOG MODEL
// ============================================

model DeliveryLog {
  id           String         @id @default(uuid()) @db.Uuid
  jobId        String         @map("job_id") @db.Uuid
  attempt      Int
  status       DeliveryStatus 
  response     Json?
  errorMessage String?        @map("error_message")
  createdAt    DateTime       @default(now()) @map("created_at")

  job          Job            @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([createdAt(sort: Desc)])
  @@map("delivery_logs")
}