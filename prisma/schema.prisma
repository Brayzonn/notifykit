generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  USER
}

enum AuthProvider {
  EMAIL
  GOOGLE
  GITHUB
}

enum CustomerPlan {
  FREE
  INDIE
  STARTUP
}

enum PaymentProvider {
  STRIPE
  PADDLE
  PAYSTACK
  FLUTTERWAVE
  LEMONSQUEEZY
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
  TRIALING
}

enum JobType {
  EMAIL
  WEBHOOK
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum DeliveryStatus {
  SUCCESS
  FAILED
}

// ============================================
// USER MODEL 
// ============================================
model User {
  id            String       @id @default(uuid()) @db.Uuid
  email         String       @unique
  password      String?
  name          String
  company       String?
  avatar        String?
  role          UserRole     @default(USER)
  provider      AuthProvider @default(EMAIL)
  providerId    String?      @map("provider_id")
  emailVerified Boolean      @default(false) @map("email_verified")
  deletedAt     DateTime?    @map("deleted_at")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  refreshTokens RefreshToken[]
  customer      Customer?

  @@unique([provider, providerId])
  @@index([email])
  @@index([deletedAt])
  @@map("users")
}

// ============================================
// TOKEN MODELS
// ============================================
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================
// CUSTOMER MODEL 
// ============================================

model Customer {
  id                  String       @id @default(uuid()) @db.Uuid
  userId              String       @unique @map("user_id") @db.Uuid
  email               String       @unique
  apiKey              String?      @unique @map("api_key")
  apiKeyHash          String?      @unique @map("api_key_hash")
  plan                CustomerPlan @default(FREE)
  monthlyLimit        Int          @map("monthly_limit")
  usageCount          Int          @default(0) @map("usage_count")
  usageResetAt        DateTime     @default(now()) @map("usage_reset_at")
  billingCycleStartAt DateTime     @default(now()) @map("billing_cycle_start_at")
  isActive            Boolean      @default(true) @map("is_active")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  subscriptionStatus     SubscriptionStatus? @map("subscription_status")
  paymentProvider        PaymentProvider?    @map("payment_provider")
  providerCustomerId     String?             @map("provider_customer_id")
  providerSubscriptionId String?             @map("provider_subscription_id")
  subscriptionEndDate    DateTime?           @map("subscription_end_date")
  lastPaymentDate        DateTime?           @map("last_payment_date")
  nextBillingDate        DateTime?           @map("next_billing_date")
  paymentMetadata        Json?               @map("payment_metadata")

  previousPlan CustomerPlan? @map("previous_plan")
  downgradedAt DateTime?     @map("downgraded_at")

  sendingDomain     String?   @map("sending_domain")
  domainVerified    Boolean   @default(false) @map("domain_verified")
  sendgridDomainId  String?   @unique @map("sendgrid_domain_id")
  domainDnsRecords  Json?     @map("domain_dns_records")
  domainRequestedAt DateTime? @map("domain_requested_at")
  domainVerifiedAt  DateTime? @map("domain_verified_at")

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs Job[]

  @@index([apiKeyHash])
  @@index([email])
  @@index([userId])
  @@index([subscriptionStatus])
  @@index([providerSubscriptionId])
  @@index([paymentProvider])
  @@map("customers")
}

// ============================================
// JOB MODEL
// ============================================
model Job {
  id             String    @id @default(uuid()) @db.Uuid
  customerId     String    @map("customer_id") @db.Uuid
  type           JobType
  status         JobStatus @default(PENDING)
  priority       Int       @default(5)
  payload        Json
  attempts       Int       @default(0)
  maxAttempts    Int       @default(3) @map("max_attempts")
  errorMessage   String?   @map("error_message")
  idempotencyKey String?   @map("idempotency_key")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")

  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  deliveryLogs DeliveryLog[]

  @@unique([customerId, idempotencyKey])
  @@index([customerId])
  @@index([status])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@map("jobs")
}

// ============================================
// DELIVERY LOG MODEL
// ============================================

model DeliveryLog {
  id           String         @id @default(uuid()) @db.Uuid
  jobId        String         @map("job_id") @db.Uuid
  attempt      Int
  status       DeliveryStatus
  response     Json?
  errorMessage String?        @map("error_message")
  createdAt    DateTime       @default(now()) @map("created_at")

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([createdAt(sort: Desc)])
  @@map("delivery_logs")
}
